<?xml version="1.0" encoding="UTF-8"?>
<project name="xp-framework-test" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">
  <available property="build.test.exist.unittest.ini" file="${basedir}/unittest.ini"/>

  <target name="xp.test.createpath">
    <!-- Build classpath for unittests -->
    <ivy:cachefileset
     type="xar"
     conf="*"
     setid="test.path.dependencies"
    />
    <pathconvert property="test.path" pathsep="&#10;">
      <path>
        <pathelement path="${build.target.testClasses}"/>
        <pathelement path="${build.target.classes}"/>
        <fileset refid="test.path.dependencies"/>
        <pathelement path="${build.target}/bootstrap"/>
      </path>
    </pathconvert>

    <!-- Generate ivy.pth for use by tests -->
    <echo file="${build.target}/bootstrap/ivy.pth">${test.path}</echo>
    <pathconvert property="test.use_xp">
      <path>
        <pathelement path="${build.target}/bootstrap"/>
      </path>
    </pathconvert>

    <mkdir dir="${build.target}/testresults"/>
  </target>

  <target name="xp.test.byini" unless="skip.tests" depends="xp.test.createpath">
    <echo>===> Testing ${ivy.organisation}#${ivy.module} - by configuration</echo>

    <!-- Execute unittest for each .ini file -->
    <apply
     executable="unittest"
     failonerror="true"
     dir="${build.target}/bootstrap"
     dest="${build.target}/testresults"
    >
      <env key="USE_XP" value="${test.use_xp}"/>
      <arg value="-l"/>
      <arg value="unittest.XmlTestListener"/>
      <mapper type="glob" from="*.ini" to="*.xml"/>
      <targetfile prefix="testresult-"/>
      <srcfile/>
      <fileset refid="build.testConfigurations"/>
    </apply>
  </target>

  <target name="xp.test.bypackage" if="build.testPackage" depends="xp.test.createpath">
    <echo>===> Testing ${ivy.organisation}#${ivy.module} - by package</echo>

    <!-- Execute unittest -->
    <exec
     executable="unittest"
     failonerror="true"
    >
      <env key="USE_XP" value="${build.target}/bootstrap/"/>
      <arg value="-l"/>
      <arg value="unittest.XmlTestListener"/>
      <arg value="${build.target}/testresults/testresult-package.xml"/>
      <arg value="${build.testPackage}"/>
    </exec>
  </target>

  <target name="xp.test" extensionOf="test" depends="xp.test.byini,xp.test.bypackage"/>
</project>